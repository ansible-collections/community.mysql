---
- name: Utils | Assert user password_expire | Create modify {{ username }} with password_expire
  mysql_user:
    login_user: "{{ mysql_parameters.login_user }}"
    login_password: "{{ mysql_parameters.login_password }}"
    login_host: "{{ mysql_parameters.login_host }}"
    login_port: "{{ mysql_parameters.login_port }}"
    state: present
    name: "{{ username }}"
    host: "{{ host }}"
    password: "{{ password }}"
    password_expire: "{{ password_expire }}"
    password_expire_interval: "{{ password_expire_interval | default(omit) }}"
  register: result

- name: Utils | Assert user password_expire | Assert a change occurred
  assert:
    that: "result.changed  == {{ expect_change }}"

- name: Utils | Assert user password_lifetime | Query user '{{ username }}'
  command: '{{ mysql_command }} -BNe "SELECT IFNULL(password_lifetime, -1) FROM mysql.user where user=''{{ username }}'' and host=''{{ host }}''"'
  register: password_lifetime
  when:
    - db_engine == 'mysql'
    - db_version is version('5.7.0', '>=')

- name: Utils | Assert user password_lifetime | Assert password_lifetime is in user stdout
  assert:
    that:
      - "'{{ expected_password_lifetime }}' in password_lifetime.stdout_lines"
  when:
    - db_engine == 'mysql'
    - db_version is version('5.7.0', '>=')

- name: Utils | Assert user password_lifetime | Query user '{{ username }}'
  command:
    "{{ mysql_command }} -BNe \"SELECT JSON_EXTRACT(Priv, '$.password_lifetime') AS password_lifetime \
    FROM mysql.global_priv \
    WHERE user='{{ username }}' and host='{{ host }}'\""
  register: password_lifetime
  when:
    - db_engine == 'mariadb'
    - db_version is version('10.4.3', '>=')

- name: Utils | Assert user password_lifetime | Assert password_lifetime is in user stdout
  assert:
    that:
      - "'{{ expected_password_lifetime }}' in password_lifetime.stdout_lines"
  when:
    - db_engine == 'mariadb'
    - db_version is version('10.4.3', '>=')

- name: Utils | Assert user password_expired | Query user '{{ username }}'
  command: "{{ mysql_command }} -BNe \"SELECT password_expired FROM mysql.user \
    WHERE user='{{ username }}' and host='{{ host }}'\""
  register: password_expired
  when: (db_engine == 'mysql' and db_version is version('5.7.0', '>=')) or
    (db_engine == 'mariadb' and db_version is version('10.4.3', '>='))

- name: Utils | Assert user password_expired | Assert password_expired is in user stdout
  assert:
    that:
      - "'{{ expected_password_expired }}' in password_expired.stdout_lines"
  when: (db_engine == 'mysql' and db_version is version('5.7.0', '>=')) or
    (db_engine == 'mariadb' and db_version is version('10.4.3', '>='))
